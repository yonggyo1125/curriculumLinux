# 보안을 위한 네트워크 설계

- 악의적인 침입으로부터 내부의 컴퓨터들을 보호하기 위한 것이다. 네트워크 보안에는 다양한 방법이 있지만, 중요한 것은 네트워크 설계를 안전하게 하는 것이다. 
- 가장 안전한 네트워크 설계는 내부의 네트워크와 외부를 완전히 차단해 내부에서 외부로 접속하지못하도록 고립시키는 것이다. 
- 하지만 이 방법은 특수한 몇몇 환경을 제외하고는 구성하지 않는다. 도둑이 무서워서 집의 문과 창문을 완전히 폐쇄하고 집 밖에 나가지 않는 것과 마찬가지 상황이기때문이다.

- 그래서 내부의 사용자는 외부의 인터넷을 이용할 수 있지만 외부에서는 내부로 침입할 수 없게 하는 방법이 필요해졌다. 그중 가장 보편적으로 많이 사용하는 방법이 흔히 사설 IP(Private IP)라고 불리는 nonroutable IP 주소를 이용하는 것이다.

- 이 방법은 내부 컴퓨터 사이의 트래픽은 허용하면서 외부 인터넷과의 접속은 허용 또는 제한할 수있는 쉽고 좋은 방법이다.

- 이 사설 IP의 주소 범위는 10.0.0.0~10.255.255.255, 172․16.0.0~172.31.255.255, 192.168.0.0~192.168.255.255의 세 가지가 있다.

- 이 주소 범위에 있는 컴퓨터는 인터넷 라우터를 통과할 수 없다. 그래서 외부의 컴퓨터는 이 주소 범위에 있는 컴퓨터에 접근할 수 없게 된다. 하지만 이 주소의 컴퓨터 또한 외부 인터넷으로 나갈 수가 없다. 
- 그래서 사설 IP 주소의 컴퓨터가 외부 인터넷에 접속할 수 있도록 해주는 IP 마스커레이딩(Masquerading)이라는 방법을 활용한다 (일부는 IP 위장이라고 부르기도 하지만, 그냥 마스커레이딩이라고 부르겠다). 이 방법은 잠시 후에 다룰 것이므로 이 정도만 이야기하고 방화벽 컴퓨터의 구성을 살펴보자.

- 방화벽이란 외부의 공개된 네트워크와 내부의 사설 네트워크 사이에서 외부와 내부에 전달되는 트래픽을 '정책Policy'에 따라 허용 또는 거부하는 역할을 하는 컴퓨터나 장치를 말한다. 다음 그림은 간단하고 보편적인 방화벽으로 구성된 사설 네트워크 환경이다.

![image1](https://raw.githubusercontent.com/yonggyo1125/curriculumLinux/master/Linux2/15~16%EC%9D%BC%EC%B0%A8(6h)%20-%20%EB%B0%A9%ED%99%94%EB%B2%BD/images/image1.png)

- 위 그림을 보면 방화벽이 하는 역할을 잘 이해할 수 있을 것이다. 먼저 각 장치의 역할을 간단히 살펴보자.
	- (1) 사설 네트워크는 회사의 내부라고 생각하면 된다. 그림에는 2대뿐이지만 실무에서는 더 많은 컴퓨터가 있을 것이다.
	- (2) 외부 네트워크는 특정 컴퓨터가 아닌 인터넷상의 모든 컴퓨터라고 생각하면 된다.
	- (3) 방화벽 컴퓨터에는 2개의 네트워크 카드(랜카드)가 설치되어 있어야 한다. 그림에 나와 있듯이 하나는 내부의 사설 네트워크에 연결될 네트워크 카드고, 다른 하나는 외부의 인터넷과 연결될 네트워크 카드다.
	- (4) 허브는 내부에 있는 여러 대의 컴퓨터와 방화벽을 연결하는 장치다. 내부의 컴퓨터가 1대뿐이라면 허브는 없어도 될 것이다. 실무에서는 주로 성능이 좋고 고가인 스위칭 허브를 많이 사용한다.

- 이번에는 작동 원리를 살펴보자.
	- (1) 사설 네트워크 안의 컴퓨터들은 외부의 인터넷에 접속할 수 있어야 한다. 따라서 사설 네트워크 안에 있는 컴퓨터들의 네트워크 정보 중, 게이트웨이 주소는 방화벽 컴퓨터의 [사설 IP 3]으로 지정되어 있어야 한다. 그래야만 게이트웨이를 통해 외부의 인터넷에 접속할 수 있다.<br>만약 리눅스 클라이언트가 방화벽 컴퓨터를 통해 외부 네트워크 [공인 IP 2]의 Windows 컴퓨터에 접속했다면, 외부의 Windows 컴퓨터 입장에서는 리눅스 클라이언트의 [사설 IP 1]이 접근했다는 사실을 알지 못하며, 단지 방화벽 컴퓨터의 [공인 IP 1]로 접속되었다는 사실만 알 수 있다. 결론적으로 사설 네트워크의 모든 컴퓨터가 외부 인터넷을 사용할 때는 방화벽의 [공인 IP 1]을 사용하게 된다. 이러한 것을 마스커레이딩Masquerading이라고 부른다.
	- (2) NAT(Nerwork Address Translation)의 기능을 알아보자. 리눅스 클라이언트가 [사설 IP 1]로 방화벽의 [사설 IP 3]과 [공인 IP 1]을 통해 외부 서버로 접속하려면 패킷을 전송하게 된다. 그리고 이 외부 서버는 접속한 리눅스 클라이언트에게 응답 패킷을 전송하려고 할 때, 리눅스 클라이언트의 IP 주소를 [사설 IP 1]이 아닌 [공인 IP 1]로 알고 있어서 [공인 IP 1]로 전송하게 된다. 그러면 방화벽컴퓨터는 해당 패킷을 [사설 IP 1]로 전송한다. 이러한 것을 SNAT(Source NAT)라고 부른다.<br>이는 마스커레이드와 거의 유사한 기능이며, 대개 사설 IP 주소를 동적으로 운영할 때는 마스커레이드를 사용하고 사설 IP를 고정으로 운영할 때는 SNAT를 사용한다.
	- (3) 이번에는 외부에서 [사설 IP 2]를 이용하는 리눅스 웹 서버에 접속할 때를 생각해보자. [공인 IP 2]를 사용하는 Windows 컴퓨터는 일단 방화벽의 [공인 IP 1]로 접속해야 하며, 방화벽 컴퓨터가 이 패킷을 내부의 [사설 IP 2]에게 전송한다. 이러한 기능을 DNAT(Destination NAT)라고 부른다.<br>이러한 기능들은 자동으로 사용할 수 있는 것이 아니라 서버 관리자가 직접 설정해줘야 한다. 이렇게 서버 관리자가 여러 가지 규칙을 지정해주는 것을 '정책 수립'이라고 한다. 즉 방화벽 컴퓨터는 서버 관리자에 따라 아주 강력한 보안 정책을 유지할 수도 있고 유연한 보안 정책을 갖게 될 수도 있으며, 없는 것과 마찬가지일 수도 있다.<br>실제로 아주 비싼 방화벽 장비를 설치한 곳에서도 내부와 외부의 모든 패킷을 허용하는 규칙을 설정해서 방화벽이 없는 것과 마찬가지로 운영하는 경우도 있다. 이는 서버 관리자가 보안에 전혀 관심이 없거나 방화벽 개념이 전무하기 때문일 것이다.<br>결론적으로 방화벽 컴퓨터 운영에서는 '정책'을 어떻게 수립하느냐의 문제가 더 중요하다고 할 수 있다.

* * *
# 리눅스 방화벽 컴퓨터 구축

- 위 그림과 같이 구성하려면 컴퓨터 4대, 랜카드 총 5개, 공인 IP 2개, 허브 등의 장치가 필요하다. 만약 이와 같은 장비를 모두 갖고 있는 독자라면 실습이 훨씬 간편해질 것이다. 하지만 대부분은 1개의 랜카드가 설치된 컴퓨터를 사용할 것이다.


- 이번 실습은 VirtualBox의 장점을 십분 활용할 수 있는 실습이다. 그래서 가상머신의 구성도 기존에 비해 더 복잡하다. 이번 실습을 잘 진행하려면 다음의 구성을 잘 이해해야 한다. 좀 복잡하지만 차근차근 살펴보자. 이번 실습을 원활히 진행하면 실무에서 여러 대의 컴퓨터로 방화벽을 구성할 때 훨씬 더 쉽게 작업할 수 있을 것이다.
	
![image2](https://raw.githubusercontent.com/yonggyo1125/curriculumLinux/master/Linux2/15~16%EC%9D%BC%EC%B0%A8(6h)%20-%20%EB%B0%A9%ED%99%94%EB%B2%BD/images/image2.png)

- (1) 위 그림은 처음 제시한 이미지와 거의 같지만, 여기서 미리 이해하고 넘어갈 것이 있다.<br>현재 우리는 VirtualBox 내부에서 가상 컴퓨터를 사용하므로, 사설 IP 주소 범위를 10.0.1.000로 사용한다는 것을 기억할 것이다. 앞에서도 이야기했고, 또 여러분도 잘 알고 있듯이 이는 사설 IP 주소다. 그런데 이번 실습을 원활히 하려면 다음처럼처럼 공인 IP가 두 개 필요하다.<br>그래서 이번 실습에서는 10.0.2.000와 그 외의 IP 주소를 공인 IP 주소로 취급해 실습을 진행한다. 그리고 Client와 Server(B)가 포함된 사설 네트워크의 사설 IP 주소는 10.1.1.xxx를 사용한다. 이번 실습의 경우 실제로 여러 대의 컴퓨터를 사용하면 오히려 구현하기 쉽다. 우리는 제약된 환경(VirtualBox상)에서 실제 물리 환경과 동일한 구성을 실습하려는 것이므로 몇 가지 제약이 따르는 것뿐이다.

- (2) Client와 Server(B)는 기존처럼 네트워크 카드를 하나 설치해 사용한다. 그런데 이번 실습에서는 VirtualBox에서 가상머신의 네트워크로 지정했던 NAT를 Bridged Network로 변경해 사용할 것이다. 이렇게 하면 위 이미지의 왼쪽처럼 2대의 컴퓨터를 허브(가상)로 연결해 사설 네트워크상에 독립적으로 구성한 것과 같은 효과를 낼 수 있다. 그러면 호스트 운영체제를 비롯한 외부 컴퓨터가 사설 네트워크 안으로 접근할 수 없게 된다.

- (3) Server에는 네트워크 카드를 2개 장착하겠다. 1개는 사설 네트워크에 포함되도록 허브(가상)에 연결한다. 그러려면 VirtualBox의 네트워크를 Bridged Network 로 설정하고, IP 주소를 10.1.1.1로 사용한다. 이는 사설 네트워크의 컴퓨터들이 외부 인터넷으로 연결되는 데 필요한 게이트웨이 역할을 할 것이다.<br>다른 1개(enps0s3)에는 외부와 연결되는 공인 IP (10.0.2.100)를 할당한다. 그러기 위해 VirtualBox의 네트워크를 NAT 로 설정한다

>  Server에 추가로 장착된 네트워크 카드의 이름은 필자의 경우 ens224로 할당되지만,  VirtualBox버전이나 네트워크 상태에 따라 다른 이름으로 할당될 수도 있다. 실습에서는 ens224로 계속 언급하겠으나,  자신에게 할당된 네트워크 카드의 이름을 사용해야 한다.

- (4) 호스트 운영체제(또는 WinClient)는 외부 인터넷상에 존재하는 컴퓨터로 사용된다. 이는 순수한 사용자 컴퓨터가 될 수도 있고, 악의적인 해커의 컴퓨터가 될 수도 있다.

- (5) 현재까지는 하드웨어와 운영체제만 구성해놓았다. 이제는 '정책 수립' 단계다. 이번 실습에서는다음과 같이 간단한 정책을 수립한다. 당연히 이 정책은 방화벽 컴퓨터인 Server에 적용할 내용이다.
	- 내부 컴퓨터는 외부 인터넷을 사용할 수 있도록 한다.
	- 외부 컴퓨터는 기본적으로 내부에 접속할 수 없도록 한다.
	- 외부 컴퓨터가 방화벽 서버의 공인 IP (10.0.2.100)로 웹 서비스를 요청할 때는 내부에있는 Server(B)(10.1.1.20)가 서비스할 수 있도록 한다

> 이번 실습에서는 10.1.1.xxx 외의 모든 IP 주소는 공인 IP로 간주하기로 했다.

### 실습 1

방화벽 컴퓨터를 구현해보자

#### step 0

<code>호스트 운영체제</code> 3대의 가상머신을 초기화한다.

- Server, Server(B), Client를 각각 처음 설치 상태로 초기화하자
- 모두 부팅하고, Server와 Server (B)는 root 사용자로 접속한다.
- Server와 Server(B)에서 <b>dnf -y install iptables-services</b> 명령으로 필요한 패키지를 미리 설치해놓자.
- Client에서 <b>su-c 'gedit /etc/sysconfig/selinux'</b> 명령으로 행쯤을 'SELINUX=disabled'로 변경하고 재부팅하자.

> 이번 실습에서도 세 대의 CentOS에는 SELinux 기능이 모두 꺼져(Off) 있어야 한다

#### step1

<code>호스트 운영체제</code> 설정된 네트워크를 확인해보자.

#### step 2

<code>Server(B)</code> 위 그림의 구성대로 Server(B)의 IP 주소도 변경하자(IP : 10.1.1.20, Subnet Mask : 255.255.255.0, GATEWAY: 10.1.1.1)

- 네트워크 정보를 변경하자. <b>nmtui edit enp0s3</b> 명령을 입력한다.

![image4](https://raw.githubusercontent.com/yonggyo1125/curriculumLinux/master/Linux2/15~16%EC%9D%BC%EC%B0%A8(6h)%20-%20%EB%B0%A9%ED%99%94%EB%B2%BD/images/image4.png)

- [Edit connection] 창이 나오고 기존에 사용했던  IP 주소 관련 정보가 설정되어 있다.
- 네트워크 정보를 설정한다. 다음과 같이 동일하게 입력한다. [Tab]을 이용해서 위치를 이동하면 된다.

```
Address: 10.1.1.20/24     -> 뒤의 24는 Netmask를 255.255.255.0으로 설정하는 것
Gateway: 10.1.1.1
DNS Server: 8.8.8.8    -> 구글에서 운영하는 공인 DNS 서버
```

![image3](https://raw.githubusercontent.com/yonggyo1125/curriculumLinux/master/Linux2/15~16%EC%9D%BC%EC%B0%A8(6h)%20-%20%EB%B0%A9%ED%99%94%EB%B2%BD/images/image3.png)


- 위와 같이 설정되었으면 제일 아래의 \<Ok\> 버튼으로 이동한 후 [Enter]를 눌러 설정을 마친다.
- 다음 명령을 입력해서 설정한 내용을 적용시키자

```
nmcli connection down enp0s3  -> 네트워크 장치 중지
nmcli connection up enp0s3    -> 네트워크 장치 시작
```